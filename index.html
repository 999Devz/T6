<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tahiri</title>

<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --accent:#7a0000;
  --text:#f2f2f2;
  --muted:#9a9a9a;
  --error:#ff4d4d;
}

*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:var(--bg);color:var(--text);}

header{
  position:fixed;top:0;left:0;width:100%;height:60px;
  display:flex;align-items:center;padding:0 16px;z-index:100;
}

.menu-btn{font-size:26px;cursor:pointer;}

#overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:90;
}

#sidemenu{
  position:fixed;top:0;left:-260px;width:260px;height:100%;
  background:#0f0f0f;padding:20px;transition:.3s;z-index:100;
}

#sidemenu a{
  display:block;padding:12px 0;color:var(--text);
  text-decoration:none;cursor:pointer;
}

#sidemenu a:hover{color:var(--accent)}

main{
  padding-top:80px;
  max-width:1100px;
  margin:auto;
  padding-left:16px;
  padding-right:16px;
}

section{display:none}
section.active{display:block}

#homeHeader{
  display:none;
  text-align:center;
  margin-top:120px;
}
#homeHeader.active{display:block}

/* CHAT */
.chat-box{background:var(--card);padding:12px;border-radius:6px;}
.chat-feed{max-height:350px;overflow:auto;margin-bottom:10px;}
.msg{padding:6px 0;border-bottom:1px solid #222;}
.chat-input input{
  width:100%;
  padding:10px;
  background:#1e1e1e;
  border:none;
  color:white;
}
.permission-msg{
  margin-top:8px;
  font-size:13px;
  color:var(--error);
}

/* TEAM */
.team-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;
}

.member{
  background:var(--card);
  padding:16px;
  border-radius:8px;
}

.member-top{
  display:flex;
  gap:15px;
  align-items:flex-start;
}

.avatar{
  width:90px;
  height:90px;
  border-radius:50%;
  background:#333;
  background-size:cover;
  background-position:center;
  flex-shrink:0;
  cursor:pointer;
}

.member-info h4{
  margin:0;
  font-size:18px;
}

.role{
  font-size:14px;
  color:var(--muted);
  margin-top:4px;
}

.bio{
  margin-top:12px;
  font-size:14px;
  color:#ccc;
  white-space:pre-line;
}

.contact{
  margin-top:8px;
  font-size:13px;
  color:#aaa;
}

.edit-btn{
  margin-top:12px;
  background:var(--accent);
  border:none;
  color:white;
  padding:6px;
  cursor:pointer;
  width:100%;
}

/* AUTH */
.auth-box{
  max-width:420px;margin:40px auto;
  background:var(--card);padding:20px;border-radius:6px;
}

.auth-box input,.auth-box button{
  width:100%;padding:10px;margin-top:10px;
  background:#1e1e1e;color:white;border:none;
}

.auth-box button{background:var(--accent);cursor:pointer}

.error-msg{
  margin-top:10px;
  color:var(--error);
  font-size:13px;
}
.success-msg{
  margin-top:10px;
  color:#4dff88;
  font-size:13px;
}

/* MODAL */
.modal{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);
  display:none;align-items:center;justify-content:center;z-index:200;
}
.modal-content{
  background:var(--card);padding:20px;border-radius:8px;width:350px;
  display:flex;flex-direction:column;gap:10px;
}
.modal-content input, .modal-content select{
  padding:8px;
  background:#1e1e1e;color:white;border:none;width:100%;
}
.modal-content button{
  padding:8px;background:var(--accent);color:white;border:none;cursor:pointer;
}
</style>
</head>

<body>

<header>
  <div class="menu-btn" id="menuBtn">‚ò∞</div>
</header>

<div id="overlay"></div>

<div id="sidemenu">
  <a data-page="home">Home</a>
  <a data-page="projects">Projecten</a>
  <a data-page="team">Team</a>
  <a data-page="contact">Contact</a>
  <a data-page="donations">Donaties</a>
  <a id="authBtn">Inloggen</a>
</div>

<main>

  <div id="homeHeader">
    <h1>TAHIRI</h1>
    <p>De Tahiri Site</p>
  </div>

  <section id="home" class="active"></section>

  <section id="projects">
    <h2>Projecten ‚Äì Live Chat</h2>
    <div class="chat-box">
      <div class="chat-feed" id="chatFeed"></div>
      <div class="chat-input">
        <input id="chatInput" placeholder="Typ bericht...">
      </div>
      <div id="chatPermissionMsg" class="permission-msg"></div>
    </div>
  </section>

  <section id="team">
    <h2>Team</h2>
    <div id="addMemberContainer" style="margin-bottom:16px;"></div>
    <div class="team-grid" id="teamGrid"></div>
  </section>
  <section id="contact">
    <h2>Contact</h2>
    <p>Mail: TahiriBusiness@gmail.com</p>
    <p>Tiktok - TahiriBusiness</p>
    <p>Instagram - TahiriBusiness</p>
    <p>Telegram - TahiriBusiness</p>
    <p>Youtube - TahiriBusiness</p>
  </section>

  <section id="donations">
    <h2>Donaties</h2>
    <p>Soon.</p>
  </section>

  <section id="login">
    <div class="auth-box">
      <h2>Inloggen</h2>
      <input id="loginIdentifier" placeholder="Naam of email">
      <input id="loginPass" type="password" placeholder="Wachtwoord">
      <button id="loginBtn">Inloggen</button>
      <div id="loginMsg" class="error-msg"></div>

      <hr style="margin:20px 0;border:1px solid #222">

      <h2>Account maken</h2>
      <input id="regName" placeholder="Accountnaam">
      <input id="regEmail" placeholder="Email">
      <input id="regPass" type="password" placeholder="Wachtwoord">
      <button id="regBtn">Account maken</button>
      <div id="regMsg"></div>
    </div>
  </section>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Profiel Bewerken</h3>
      <input id="modalName" placeholder="Naam">
      <input id="modalEmail" placeholder="Email (priv√©)">
      <input id="modalBio" placeholder="Bio / contact info">
      <select id="modalRole">
        <option value="visitor">Visitor</option>
        <option value="member">Member</option>
        <option value="staff">Staff</option>
        <option value="leader">Leader</option>
        <option value="founder">Founder</option>
      </select>
      <input type="file" id="modalAvatar">
      <button onclick="saveEdit()">Opslaan</button>
      <button onclick="closeModal()">Annuleren</button>
    </div>
  </div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOi0LZ1aHbb2wJuVkGfGZL1FGzXkY49FA",
  authDomain: "tahiri-d0f8e.firebaseapp.com",
  databaseURL: "https://tahiri-d0f8e-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tahiri-d0f8e",
  storageBucket: "tahiri-d0f8e.firebasestorage.app",
  messagingSenderId: "478957646301",
  appId: "1:478957646301:web:4ad65ecbc4f2fbaacc4",
  measurementId: "G-044F3JSETX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM ELEMENTS
const chatInput = document.getElementById("chatInput");
const chatFeed = document.getElementById("chatFeed");
const chatPermissionMsg = document.getElementById("chatPermissionMsg");
const teamGrid = document.getElementById("teamGrid");
const authBtn = document.getElementById("authBtn");
const regMsg = document.getElementById("regMsg");
const loginMsg = document.getElementById("loginMsg");

const regName = document.getElementById("regName");
const regEmail = document.getElementById("regEmail");
const regPass = document.getElementById("regPass");
const loginIdentifier = document.getElementById("loginIdentifier");
const loginPass = document.getElementById("loginPass");
const loginBtn = document.getElementById("loginBtn");
const regBtn = document.getElementById("regBtn");

const menuBtn = document.getElementById("menuBtn");
const overlay = document.getElementById("overlay");
const sideMenu = document.getElementById("sidemenu");

// DATABASE REFERENCES
const usersRef = ref(db,'users');
const feedRef = ref(db,'chatFeed');
const privateFeedRef = ref(db,'privateFeed'); // <-- voor private members chat

// VARIABLES
let users = [];
let current = null;
let feed = [];
const DEFAULT_AVATAR="https://i.imgur.com/6VBx3io.png";

// --- ROLES & PERMISSIONS ---
const rolesPermissions = {
  visitor: {chatSend:false, chatEditOwn:false, chatEditAll:false},
  member: {chatSend:true, chatEditOwn:true, chatEditAll:false},
  staff: {chatSend:true, chatEditOwn:true, chatEditAll:true}, // staff kan berichten van iedereen verwijderen/bewerken
  leader: {chatSend:true, chatEditOwn:true, chatEditAll:true},
  founder: {chatSend:true, chatEditOwn:true, chatEditAll:true}
};

// --- MENU FUNCTIONS ---
function openMenu(){ sideMenu.style.left = "0px"; overlay.style.display = "block"; }
function closeMenu(){ sideMenu.style.left = "-260px"; overlay.style.display = "none"; }
function setupNavigation(){
  document.querySelectorAll("#sidemenu a[data-page]").forEach(link=>{
    link.addEventListener("click", ()=>{
      const page = link.getAttribute("data-page");
      openPage(page);
    });
  });
}
function openPage(id){
  document.querySelectorAll("main > section").forEach(s=>s.classList.remove("active"));
  const el=document.getElementById(id);
  if(el) el.classList.add("active");
  document.getElementById("homeHeader").classList.toggle("active", id==="home");
  closeMenu();
}
// --- AUTH FUNCTIONS ---
function updateAuthButton(){ authBtn.innerText = current ? "Uitloggen" : "Inloggen"; }

function updatePermissions(){
  if(!current || !rolesPermissions[current.role].chatSend){
    chatInput.disabled = true;
    chatPermissionMsg.innerText = "Je moet ingelogd zijn als member of hoger om berichten te sturen.";
  } else {
    chatInput.disabled = false;
    chatPermissionMsg.innerText = "";
  }
}

function handleAuth(){
  if(current){
    current = null;
    localStorage.removeItem("currentUserEmail");
    updatePermissions();
    updateAuthButton();
    loadTeam();
    openPage("home");
  } else {
    openPage("login");
  }
}

function register(){
  regMsg.innerHTML="";
  const name = regName.value.trim();
  const email = regEmail.value.trim();
  const pass = regPass.value.trim();
  if(!name || !email || !pass){
    regMsg.innerHTML="<div class='error-msg'>Vul alle velden in.</div>";
    return;
  }
  if(users.find(u => u.email === email)){
    regMsg.innerHTML="<div class='error-msg'>Email bestaat al.</div>";
    return;
  }
  users.push({
    id: crypto.randomUUID(),
    name, email, mail: email, pass,
    role: "visitor", avatar:"", bio:"", contact:""
  });
  saveUsers();
  regMsg.innerHTML="<div class='success-msg'>Account succesvol aangemaakt!</div>";
  regName.value=""; regEmail.value=""; regPass.value="";
}

function login(){
  loginMsg.innerHTML="";
  const id = loginIdentifier.value.trim();
  const pass = loginPass.value.trim();
  if(!id || !pass){ loginMsg.innerText="Vul alle velden in."; return; }

  const user = users.find(u => u.email===id || u.name===id);
  if(!user){ loginMsg.innerText="Account niet gevonden."; return; }
  if(user.pass!==pass){ loginMsg.innerText="Wachtwoord klopt niet."; return; }

  current = user;
  localStorage.setItem("currentUserEmail", current.email);
  updatePermissions();
  updateAuthButton();
  loadTeam();
  openPage("home");
}

// --- CHAT FUNCTIONS ---
chatInput.addEventListener("keypress", e=>{
  if(e.key==="Enter"){
    if(chatInput.disabled || !current) return;
    if(chatInput.value.trim()==="") return;
    const msg={id:crypto.randomUUID(), name:current.name, email:current.email, text:chatInput.value, timestamp:Date.now()};
    set(ref(db,'chatFeed/'+msg.id), msg);
    chatInput.value="";
  }
});

// --- RENDER CHAT WITH EDIT/DELETE ---
function renderChat(){
  chatFeed.innerHTML="";
  feed.sort((a,b)=>a.timestamp-b.timestamp).forEach(m=>{
    let canEdit = current && (m.email===current.email && rolesPermissions[current.role].chatEditOwn) || rolesPermissions[current.role].chatEditAll;
    chatFeed.innerHTML += `<div class="msg" id="msg-${m.id}">
      <b>${m.name}</b>: <span class="msg-text">${m.text}</span>
      ${canEdit?`<button onclick='editMsg("${m.id}")'>‚úèÔ∏è</button> <button onclick='deleteMsg("${m.id}")'>üóëÔ∏è</button>`:""}
    </div>`;
  });
}

// --- MESSAGE EDIT / DELETE ---
window.editMsg = function(id){
  const m = feed.find(x=>x.id===id);
  if(!m) return;
  if(!current || (!(m.email===current.email && rolesPermissions[current.role].chatEditOwn) && !rolesPermissions[current.role].chatEditAll)) return;
  const newText = prompt("Bewerk bericht:", m.text);
  if(newText!==null){
    m.text = newText;
    set(ref(db,'chatFeed/'+id), m);
  }
}

window.deleteMsg = function(id){
  const m = feed.find(x=>x.id===id);
  if(!m) return;
  if(!current || (!(m.email===current.email && rolesPermissions[current.role].chatEditOwn) && !rolesPermissions[current.role].chatEditAll)) return;
  set(ref(db,'chatFeed/'+id), null);
}

// --- PRIVATE MEMBERS-ONLY CHAT ---
const privateChatInput = document.createElement("input");
privateChatInput.placeholder = "Private members chat...";
privateChatInput.style.width = "100%";
privateChatInput.style.marginTop = "10px";

const privateChatFeed = document.createElement("div");
privateChatFeed.style.maxHeight="200px";
privateChatFeed.style.overflow="auto";
privateChatFeed.style.marginTop="5px";

document.getElementById("projects").appendChild(privateChatFeed);
document.getElementById("projects").appendChild(privateChatInput);

privateChatInput.addEventListener("keypress", e=>{
  if(e.key==="Enter"){
    if(!current || !["member","staff","leader","founder"].includes(current.role)) return;
    if(privateChatInput.value.trim()==="") return;
    const msg={id:crypto.randomUUID(), name:current.name, email:current.email, text:privateChatInput.value, timestamp:Date.now()};
    set(ref(db,'privateFeed/'+msg.id), msg);
    privateChatInput.value="";
  }
});

function renderPrivateChat(msgs){
  privateChatFeed.innerHTML="";
  msgs.sort((a,b)=>a.timestamp-b.timestamp).forEach(m=>{
    let canEdit = current && (m.email===current.email && rolesPermissions[current.role].chatEditOwn) || rolesPermissions[current.role].chatEditAll;
    privateChatFeed.innerHTML += `<div class="msg" id="pmsg-${m.id}">
      <b>${m.name}</b>: <span class="msg-text">${m.text}</span>
      ${canEdit?`<button onclick='editPrivateMsg("${m.id}")'>‚úèÔ∏è</button> <button onclick='deletePrivateMsg("${m.id}")'>üóëÔ∏è</button>`:""}
    </div>`;
  });
}

window.editPrivateMsg = function(id){
  const m = privateFeed.find(x=>x.id===id);
  if(!m) return;
  if(!current || (!(m.email===current.email && rolesPermissions[current.role].chatEditOwn) && !rolesPermissions[current.role].chatEditAll)) return;
  const newText = prompt("Bewerk bericht:", m.text);
  if(newText!==null){
    m.text = newText;
    set(ref(db,'privateFeed/'+id), m);
  }
}

window.deletePrivateMsg = function(id){
  const m = privateFeed.find(x=>x.id===id);
  if(!m) return;
  if(!current || (!(m.email===current.email && rolesPermissions[current.role].chatEditOwn) && !rolesPermissions[current.role].chatEditAll)) return;
  set(ref(db,'privateFeed/'+id), null);
}
// --- TEAM / PROFIELSYSTEEM ---
let editingId = null;

window.openEdit = function(id){
  editingId = id;
  const u = users.find(x => x.id === id);
  if(!u) return;
  document.getElementById("modalName").value = u.name;
  document.getElementById("modalEmail").value = u.email;
  document.getElementById("modalBio").value = u.bio;
  document.getElementById("modalRole").value = u.role;
  document.getElementById("editModal").style.display = "flex";
}

window.closeModal = function(){
  editingId = null;
  document.getElementById("editModal").style.display = "none";
}

document.getElementById("modalAvatar").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const u = users.find(x=>x.id===editingId);
    if(!u) return;
    u.avatar = ev.target.result;
    saveUsers(); loadTeam();
  };
  reader.readAsDataURL(file);
});

window.saveEdit = function(){
  const u = users.find(x=>x.id===editingId);
  if(!u) return;

  u.name = document.getElementById("modalName").value;
  u.email = document.getElementById("modalEmail").value;
  u.mail = u.email;
  u.bio = document.getElementById("modalBio").value;

  // Alleen founder/leader kan role aanpassen
  if(current && ["leader","founder"].includes(current.role)){
    u.role = document.getElementById("modalRole").value;
  }

  saveUsers(); loadTeam(); closeModal();
}

// --- RENDER TEAM GRID ---
function loadTeam(){
  teamGrid.innerHTML = "";
  users.forEach(u=>{
    let canEdit = false;
    if(current){
      if(["leader","founder"].includes(current.role) || current.email===u.email) canEdit=true;
    }

    teamGrid.innerHTML += `
      <div class="member">
        <div class="member-top">
          <div class="avatar" style="background-image:url('${u.avatar || DEFAULT_AVATAR}')"></div>
          <div class="member-info">
            <h4>${u.name}</h4>
            <div class="role">${u.role}</div>
          </div>
        </div>
        <div class="bio">${u.bio||""}</div>
        <div class="contact">${u.contact||""}</div>
        ${canEdit?`<button class="edit-btn" onclick='openEdit("${u.id}")'>Edit</button>`:""}
      </div>`;
  });

  renderAddMemberButton();
}

// --- ADD MEMBER BUTTON ---
function renderAddMemberButton(){
  const container = document.getElementById("addMemberContainer");
  container.innerHTML = "";
  if(current && ["leader","founder"].includes(current.role)){
    const btn = document.createElement("button");
    btn.innerText = "Nieuw Profiel";
    btn.style.background = "var(--accent)";
    btn.style.color = "white";
    btn.style.border = "none";
    btn.style.padding = "8px 12px";
    btn.style.cursor = "pointer";
    btn.addEventListener("click", ()=>{
      const newUser = { id:crypto.randomUUID(), name:"Nieuw Lid", email:"", mail:"", pass:"", role:"visitor", avatar:"", bio:"", contact:"" };
      users.push(newUser);
      saveUsers(); loadTeam(); openEdit(newUser.id);
    });
    container.appendChild(btn);
  }
}

// --- INIT & LISTENERS ---
async function init(){
  setupNavigation();

  const snapUsers = await get(usersRef);
  if(snapUsers.exists()) users = Object.values(snapUsers.val());

  // --- Login persist ---
  const storedEmail = localStorage.getItem("currentUserEmail");
  if(storedEmail) current = users.find(u=>u.email===storedEmail) || null;

  loadTeam();

  const snapFeed = await get(feedRef);
  if(snapFeed.exists()) feed = Object.values(snapFeed.val());
  renderChat();

  // Private feed
  const snapPrivate = await get(ref(db,'privateFeed'));
  if(snapPrivate.exists()) privateFeed = Object.values(snapPrivate.val());
  renderPrivateChat(privateFeed);

  // Real-time listeners
  onValue(feedRef, snap=>{ if(snap.exists()){ feed = Object.values(snap.val()); renderChat(); }});
  onValue(ref(db,'privateFeed'), snap=>{ if(snap.exists()){ privateFeed = Object.values(snap.val()); renderPrivateChat(privateFeed); }});
  onValue(usersRef, snap=>{ if(snap.exists()){ users = Object.values(snap.val()); loadTeam(); }});

  updatePermissions();
  updateAuthButton();
  openPage("home");
}

// --- EVENT LISTENERS ---
menuBtn.addEventListener("click", openMenu);
overlay.addEventListener("click", closeMenu);
authBtn.addEventListener("click", handleAuth);
loginBtn.addEventListener("click", login);
regBtn.addEventListener("click", register);

document.addEventListener("DOMContentLoaded", ()=>{ init(); });
